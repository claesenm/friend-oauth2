<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>Usage</title><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="highlight/solarized-light.css" /><script type="text/javascript" src="highlight/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a> with <a href="https://github.com/xsc/codox-theme-rdash">RDash UI</a> theme</h2><h1><a href="index.html"><span class="project-title"><span class="project-name">friend-oauth2</span> <span class="project-version">0.2.0</span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Topics</span></h3><ul><li class="depth-1  current"><a href="10-usage.html"><div class="inner"><span>Usage</span></div></a></li><li class="depth-1 "><a href="20-configurtion.html"><div class="inner"><span>Configuration Reference</span></div></a></li><li class="depth-1 "><a href="30-testing.html"><div class="inner"><span>Testing</span></div></a></li><li class="depth-1 "><a href="35-contributing.html"><div class="inner"><span>Contributing</span></div></a></li><li class="depth-1 "><a href="40-todo.html"><div class="inner"><span>TODO</span></div></a></li><li class="depth-1 "><a href="50-examples.html"><div class="inner"><span>Examples</span></div></a></li><li class="depth-1 "><a href="80-change-history.html"><div class="inner"><span>Change History</span></div></a></li><li class="depth-1 "><a href="89-related.html"><div class="inner"><span>Related Projects</span></div></a></li><li class="depth-1 "><a href="99-other-versions.html"><div class="inner"><span>Other Versions</span></div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>friend-oauth2</span></div></div></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>examples</span></div></div></li><li class="depth-3 branch"><a href="friend-oauth2.examples.appdotnet.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>appdotnet</span></div></a></li><li class="depth-3 branch"><a href="friend-oauth2.examples.facebook.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>facebook</span></div></a></li><li class="depth-3 branch"><a href="friend-oauth2.examples.github.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>github</span></div></a></li><li class="depth-3"><a href="friend-oauth2.examples.google.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>google</span></div></a></li><li class="depth-2 branch"><a href="friend-oauth2.util.html"><div class="inner"><span class="tree" style="top: -145px;"><span class="top" style="height: 154px;"></span><span class="bottom"></span></span><span>util</span></div></a></li><li class="depth-2"><a href="friend-oauth2.workflow.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>workflow</span></div></a></li></ul></div><div class="document" id="content"><div class="doc"><div class="markdown"><h1><a href="#usage" name="usage"></a>Usage</h1>
<h2><a href="#1-add-the-library-to-your-project" name="1-add-the-library-to-your-project"></a>1) Add the library to your project</h2>
<p>In project.clj:</p>
<pre><code class="clojure">[clojusc/friend-oauth2 "0.2.0"]
</code></pre>
<p>As a security best practice, it is strongly recommended that you use <a href="https://github.com/weavejester/environ">Environ</a> or similar to store your credentials in environment variables, rather than hardcode any credentials into the source code itself. In this way, if an attacker steals your code, they still won’t be able to use your credentials.</p>
<p>To use Environ, also add:</p>
<pre><code class="clojure">[environ "0.5.0"]
</code></pre>
<p>to your project.clj.</p>
<h2><a href="#2-obtain-third-party-credentials" name="2-obtain-third-party-credentials"></a>2) Obtain third party credentials</h2>
<p>To be able to use friend-oauth2, you must obtain site credentials from the third party providers you wish to authenticte against, then provide those credentials to friend-oauth2. The exact procedure for obtaining the credentials varies by provider; consult their docs for details. You will be given a <code>:client-id</code> and a <code>:client-secret</code>. (These are for your server code, not for your clients - you are a client of the third party provdier.)</p>
<h2><a href="#3-set-up-friend-and-your-main-ring-handler-stack-" name="3-set-up-friend-and-your-main-ring-handler-stack-"></a>3) Set up Friend and your main Ring handler stack.</h2>
<p>Besides friend-oauth2, you must also set up Friend itself. This is typically done near where your main Ring app stack is being constructed. friend-oauth2 is then given to Friend as a possible workflow. It’s easy to use other workflows besides friend-oauth2 in the same app, too. See the [Friend docs][1] for more information on setting up Friend itself.</p>
<p>Near where your Ring stack is being constructed, add the following requires:</p>
<pre><code class="clojure">(ns your.ns.here
  (:require [cemerick.friend        :as friend]
            [friend-oauth2.workflow :as oauth2]
            [friend-oauth2.util     :refer [format-config-uri]]
            [environ.core           :refer [env]])
</code></pre>
<h2><a href="#4-provide-your-oauth2-client-id-and-client-secret-to-friend-oauth2" name="4-provide-your-oauth2-client-id-and-client-secret-to-friend-oauth2"></a>4) Provide your OAuth2 client-id and client-secret to friend-oauth2</h2>
<p>Using Environ and <a href="https://developers.google.com/accounts/docs/OAuth2">Google APIs OAuth2</a> as an example:</p>
<pre><code class="clojure">(def client-config
  {:client-id     (env :friend-oauth2-client-id)
   :client-secret (env :friend-oauth2-client-secret)
   :callback      {:domain "http://localhost:8090" ;; replace this for production with the appropriate site URL
                   :path "/oauth2callback"}})
</code></pre>
<p>In <code>~/.lein/profiles.clj</code>, add your actual credentials (N.B. this file is <em>not</em> checked into source control! It should only be present on your local machine, and should be protected from other users as it contains sensitive passwords):</p>
<pre><code class="clojure">{:user {:env {
    :friend-oauth2-client-id "12345.apps.googleusercontent.com"
    :friend-oauth2-client-secret "xyz"
}}
</code></pre>
<p>In production, these can be set at the ops level as ordinary environment variables (with underscores instead of dashes):</p>
<pre><code>export FRIEND_OAUTH2_CLIENT_ID=12345.apps.googleusercontent.com
export FRIEND_OAUTH2_CLIENT_secret=xyz
./bin/run-my-app.sh
</code></pre>
<h2><a href="#5-set-up-your-credential-fn-to-find-user-metadata" name="5-set-up-your-credential-fn-to-find-user-metadata"></a>5) Set up your credential-fn to find user metadata</h2>
<p>If the user login succeeds on the third party site, you will get a token back in your <code>credential-fn</code> uniquely identifying the user. You can use this token to look up user metadata from the third party service. What metadata you can look up is provider-specific. You can also use it to create accounts in your own system, assign roles to the user, and so on, as your particular app requires..</p>
<pre><code class="clojure">(defn credential-fn
  "Upon successful authentication with the third party, Friend calls
  this function with the user's token. This function is responsible for
  translating that into a Friend identity map with at least the :identity
  and :roles keys. How you decide what roles to grant users is up to you;
  you could e.g. look them up in a database.

  You can also return nil here if you decide that the token provided
  is invalid. This could be used to implement e.g. banning users.

  This example code just automatically assigns anyone who has
  authenticated with the third party the nominal role of ::user."
  [token]
    {:identity token
     :roles #{::user}})
</code></pre>
<p><code>credential-fn</code> behaves slightly differently differently in friend-oauth2 than in other workflows: it allows you to intercept the access token at the end of the 3rd-party authentication process and inject your own functionality. This is an artifact of OAuth2’s original purpose as a protocol for obtaining 3rd-party <strong>authorization</strong> of third party resources, not <strong>authentication</strong> of user identity as such. It therefore does not return the user metadata you probably find interesting; just a token. However, nowadays almost everyone uses OAuth primarily for authentication rather than authorization, so it is typical to find e.g. local database interaction in your own system, or third party metadata lookup here.</p>
<h2><a href="#6-configure-the-third-partys-oauth2-urls" name="6-configure-the-third-partys-oauth2-urls"></a>6) Configure the third party’s OAuth2 URLs</h2>
<p>Create the following data structure, given with Google as the example. Consult the examples and the third party’s documentation for the URLs to use with other providers.</p>
<pre><code class="clojure">(def uri-config
  {:authentication-uri {:url "https://accounts.google.com/o/oauth2/auth"
                        :query {:client_id (:client-id client-config)
                               :response_type "code"
                               :redirect_uri (format-config-uri client-config)
                               :scope "email"}}

   :access-token-uri {:url "https://accounts.google.com/o/oauth2/token"
                      :query {:client_id (:client-id client-config)
                              :client_secret (:client-secret client-config)
                              :grant_type "authorization_code"
                              :redirect_uri (format-config-uri client-config)}}})
</code></pre>
<h2><a href="#7-add-the-workflow-to-your-friend-handler" name="7-add-the-workflow-to-your-friend-handler"></a>7) Add the workflow to your Friend handler</h2>
<p>Finally, create an OAuth2 workflow and add it to your Friend handler, then add the Friend handler to your Ring stack:</p>
<pre><code class="clojure">(def friend-config
  {:allow-anon? true
   :workflows   [(oauth2/workflow
                  {:client-config client-config
                   :uri-config uri-config
                   :credential-fn credential-fn})
                   ;; Optionally add other workflows here...
                   ]})

(def app
  (-&gt; my-ring-app
      (friend/authenticate friend-config)
      handler/site))
</code></pre>
<h2><a href="#8-add-restrictions-to-your-routes-and-handlers" name="8-add-restrictions-to-your-routes-and-handlers"></a>8) Add restrictions to your routes and handlers</h2>
<p>Access control is performed by Friend as usual. See [Friend’s docs][1] for the full details.</p>
<p>For example, to allow access to a certain Compojure route only to users who are logged in and have the <code>::oauth2-user</code> role:</p>
<pre><code class="clojure">(GET "/authlink" request
  (friend/authorize #{::oauth2-user} "Authorized page."))
</code></pre>
<p>Or, you can protect an entire Ring substack with Friend’s <code>wrap-authorize</code> function:</p>
<pre><code class="clojure">  (friend/wrap-authorize admin-routes #{::administrator})
</code></pre>
<p>Check out the [friend-oauth2 examples][2] and refer to the [Friend README][1] for more information.</p></div></div></div></body></html>