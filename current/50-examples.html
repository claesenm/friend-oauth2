<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>Examples</title><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="highlight/solarized-light.css" /><script type="text/javascript" src="highlight/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a> with <a href="https://github.com/xsc/codox-theme-rdash">RDash UI</a> theme</h2><h1><a href="index.html"><span class="project-title"><span class="project-name">friend-oauth2</span> <span class="project-version">0.3.0-SNAPSHOT</span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Topics</span></h3><ul><li class="depth-1 "><a href="10-usage.html"><div class="inner"><span>Usage</span></div></a></li><li class="depth-1 "><a href="20-configurtion.html"><div class="inner"><span>Configuration Reference</span></div></a></li><li class="depth-1 "><a href="30-testing.html"><div class="inner"><span>Testing</span></div></a></li><li class="depth-1 "><a href="35-contributing.html"><div class="inner"><span>Contributing</span></div></a></li><li class="depth-1 "><a href="40-todo.html"><div class="inner"><span>TODO</span></div></a></li><li class="depth-1  current"><a href="50-examples.html"><div class="inner"><span>Examples</span></div></a></li><li class="depth-1 "><a href="80-change-history.html"><div class="inner"><span>Change History</span></div></a></li><li class="depth-1 "><a href="89-related.html"><div class="inner"><span>Related Projects</span></div></a></li><li class="depth-1 "><a href="99-other-versions.html"><div class="inner"><span>Other Versions</span></div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>friend-oauth2</span></div></div></li><li class="depth-2 branch"><a href="friend-oauth2.config.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>config</span></div></a></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>examples</span></div></div></li><li class="depth-3 branch"><a href="friend-oauth2.examples.appdotnet.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>appdotnet</span></div></a></li><li class="depth-3 branch"><a href="friend-oauth2.examples.facebook.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>facebook</span></div></a></li><li class="depth-3 branch"><a href="friend-oauth2.examples.github.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>github</span></div></a></li><li class="depth-3 branch"><a href="friend-oauth2.examples.google.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>google</span></div></a></li><li class="depth-3"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>legacy</span></div></div></li><li class="depth-4 branch"><a href="friend-oauth2.examples.legacy.appdotnet.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>appdotnet</span></div></a></li><li class="depth-4 branch"><a href="friend-oauth2.examples.legacy.facebook.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>facebook</span></div></a></li><li class="depth-4 branch"><a href="friend-oauth2.examples.legacy.github.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>github</span></div></a></li><li class="depth-4"><a href="friend-oauth2.examples.legacy.google.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>google</span></div></a></li><li class="depth-2"><a href="friend-oauth2.service.html"><div class="inner"><span class="tree" style="top: -300px;"><span class="top" style="height: 309px;"></span><span class="bottom"></span></span><span>service</span></div></a></li><li class="depth-3 branch"><a href="friend-oauth2.service.appdotnet.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>appdotnet</span></div></a></li><li class="depth-3 branch"><a href="friend-oauth2.service.facebook.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>facebook</span></div></a></li><li class="depth-3 branch"><a href="friend-oauth2.service.github.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>github</span></div></a></li><li class="depth-3"><a href="friend-oauth2.service.google.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>google</span></div></a></li><li class="depth-2 branch"><a href="friend-oauth2.util.html"><div class="inner"><span class="tree" style="top: -145px;"><span class="top" style="height: 154px;"></span><span class="bottom"></span></span><span>util</span></div></a></li><li class="depth-2"><a href="friend-oauth2.workflow.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>workflow</span></div></a></li></ul></div><div class="document" id="content"><div class="doc"><div class="markdown"><h1><a href="#examples" name="examples"></a>Examples</h1>
<p>The friend-oauth2 project includes the following examples:</p>
<ul>
  <li><a href="https://developers.app.net/reference/authentication/">App.net</a></li>
  <li><a href="https://developers.facebook.com/docs/facebook-login/manually-build-a-login-flow/">Facebook</a></li>
  <li><a href="https://developer.github.com/v3/oauth/">Github</a></li>
  <li><a href="https://developers.google.com/accounts/docs/OAuth2Login">Google OAuth 2.0 Login</a></li>
</ul>
<h2><a href="#configuration" name="configuration"></a>Configuration</h2>
<p>The examples make use of the following environment variables:</p>
<ul>
  <li><code>OAUTH2_CLIENT_ID</code></li>
  <li><code>OAUTH2_CLIENT_SECRET</code></li>
  <li><code>OAUTH2_CALLBACK_URL</code></li>
</ul>
<h2><a href="#running" name="running"></a>Running</h2>
<p>Once the environment variables are set, you will be ready to run the examples. There are two sets of examples, one set for each type of configuration support <code>friend-oauth2</code> provides (see <a href="http://clojusc.github.io/friend-oauth2/current/20-configurtion.html">configuration documentation</a> for more details).</p>
<h3><a href="#record-based-configuration" name="record-based-configuration"></a>Record-based Configuration</h3>
<p>The examples configured using the new records support can be run with the following <code>lein</code> aliases:</p>
<ul>
  <li><code>lein appdotnet</code></li>
  <li><code>lein facebook</code></li>
  <li><code>lein github</code></li>
  <li><code>lein google</code></li>
</ul>
<p>Note that, under the hood, the record-based configuration is backwards-compatible with the legacy configuration.</p>
<h3><a href="#legacy-configuration" name="legacy-configuration"></a>Legacy Configuration</h3>
<p>The examples configured using the original configuration mechanism can be run with the following <code>lein</code> aliases:</p>
<ul>
  <li><code>lein legacy-appdotnet</code></li>
  <li><code>lein legacy-facebook</code></li>
  <li><code>lein legacy-github</code></li>
  <li><code>lein legacy-google</code></li>
</ul>
<h2><a href="#source-code" name="source-code"></a>Source Code</h2>
<p>We keep the example source code as part of the code in this repository:</p>
<ul>
  <li><a href="https://github.com/clojusc/friend-oauth2/tree/master/examples/friend_oauth2/examples">examples/friend_oauth2/examples</a></li>
</ul>
<p>However, we also recognize that it’s nice to see an example in the documentation itself, so we’ll take on the burden of maintaining the following text in the effort to provide a good docs experience for you :-)</p>
<p>Here’s the Google <code>friend-oauth2</code> example, runable from the commandline (e.g., with <code>lein</code>):</p>
<pre><code class="clj">(ns friend-oauth2.examples.google
  (:require [cemerick.friend :as friend]
            [cemerick.friend.workflows :as workflows]
            [cemerick.friend.credentials :as creds]
            [clojure.tools.logging :as log]
            [clojusc.twig :as logger]
            [compojure.core :as compojure :refer [GET ANY defroutes]]
            [friend-oauth2.service.google :as google]
            [friend-oauth2.util :as util]
            [org.httpkit.server :as server]
            [ring.util.response :as response]
            [ring.middleware.defaults :as ring-defaults])
  (:gen-class))

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;; Mini Webapp ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

(defn html
  [content]
  (-&gt; content
      (response/response)
      (response/header "Content-Type" "text/html")))

(def index-content
  (str "&lt;a href=\"/admin\"&gt;Admin Pages&lt;/a&gt;&lt;br /&gt;"
       "&lt;a href=\"/authlink\"&gt;Authorized page&lt;/a&gt;&lt;br /&gt;"
       "&lt;a href=\"/authlink2\"&gt;Authorized page 2&lt;/a&gt;&lt;br /&gt;"
       "&lt;a href=\"/status\"&gt;Status&lt;/a&gt;&lt;br /&gt;"
       "&lt;a href=\"/logout\"&gt;Log out&lt;/a&gt;"))

(defn get-status-content
  [count session]
  (str "&lt;p&gt;We've hit the session page "
       count
       " times.&lt;/p&gt;&lt;p&gt;The current session: "
       session
       "&lt;/p&gt;"))

(defn render-index-page
  [req]
  (html index-content))

(defn render-status-page
  [req]
  (let [count (:count (:session req) 0)
        session (assoc (:session req) :count (inc count))]
    (-&gt; (get-status-content count session)
        (html)
        (assoc :session session))))

(defroutes app-routes
  (GET "/" req
       (render-index-page req))
  (GET "/status" req
       (render-status-page req))
  (GET "/authlink" req
       (friend/authorize
         #{::user}
         (html "Authorized page.")))
  (GET "/authlink2" req
       (friend/authorize
         #{::user}
         (html "Authorized page 2.")))
  (GET "/admin" req
       (friend/authorize
         #{::admin}
         (html "Only admins can see this page.")))
  (friend/logout (ANY "/logout" req (response/redirect "/"))))

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;; OAuth2 Configuration and Integration ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

(defn credential-fn
  [token]
  ;;lookup token in DB or whatever to fetch appropriate :roles
  {:identity token :roles #{::user}})

(def workflow
  (google/workflow
    {:config {:scope "email"}
     :access-token-parsefn util/get-access-token-from-params
     :credential-fn credential-fn}))

(def auth-opts
  {:allow-anon? true
   :workflows [workflow]})

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;; App Server ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

(def app
  (-&gt; app-routes
      (friend/authenticate auth-opts)
      (ring-defaults/wrap-defaults ring-defaults/site-defaults)))

(defn -main
  [&amp; args]
  (logger/set-level! '[ring friend friend-oauth2] :info)
  (log/info "Starting example server using Google OAuth2 ...")
  (server/run-server app {:port 8999}))
</code></pre></div></div></div></body></html>